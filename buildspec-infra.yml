version: 0.2

phases:
  install:
    runtime-versions:
      golang: 1.21
    commands:
      # Install required packages (Amazon Linux uses yum)
      - yum update -y && yum install -y bc unzip wget
      
      # Install Terraform
      - wget https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
      - unzip terraform_1.6.0_linux_amd64.zip
      - mv terraform /usr/local/bin/
      
      # Install tflint
      - curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
      
      # Install Go dependencies for tests
      - go -C infra mod download

  pre_build:
    commands:
      - echo "Running Terraform quality checks..."
      
      # Terraform formatting check
      - terraform -chdir=infra fmt -recursive
      - terraform -chdir=infra fmt -check -recursive
      
      # Terraform validation (without backend)
      - terraform -chdir=infra init -backend=false
      - terraform -chdir=infra validate
      
      # TFLint
      - (cd infra && tflint --init)
      - (cd infra && tflint)

  build:
    commands:
      - echo "Running Terraform tests..."
      
      # Run unit tests with coverage (short mode to skip slow checks)
      - CI_SKIP_TERRATEST=1 go -C infra test -v -short -coverprofile=coverage.out ./tests/
      - go -C infra tool cover -func=coverage.out

  post_build:
    commands:
      - echo "Running Terraform plan and apply..."
      
      # Create Lambda deployment package
      - (cd web/lambda && zip -r ../../infra/lambda.zip .)
      
      # Initialize Terraform backend (required for each phase)
      - terraform -chdir=infra init -reconfigure
      
      # Terraform plan
      - terraform -chdir=infra plan -out=tfplan
      
      # Terraform apply (only if not a PR)
      - |
        if [ "$CODEBUILD_WEBHOOK_EVENT" = "PULL_REQUEST_CREATED" ] || [ "$CODEBUILD_WEBHOOK_EVENT" = "PULL_REQUEST_UPDATED" ]; then
          echo "Skipping apply for pull request"
        else
          # Apply Terraform
          terraform -chdir=infra apply -auto-approve tfplan
          
          # Store infrastructure outputs in SSM Parameter Store
          echo "Storing infrastructure outputs in SSM Parameter Store..."
          
          # Store API Gateway URL
          API_GATEWAY_ID=$(terraform -chdir=infra output -raw api_gateway_id)
          API_URL="https://${API_GATEWAY_ID}.execute-api.${AWS_DEFAULT_REGION}.amazonaws.com/dev/contact"
          if aws ssm put-parameter --name "/project3/api-gateway-url" --value "$API_URL" --type "String" --overwrite; then
            echo "âœ… Stored API Gateway URL: $API_URL"
          else
            echo "âš ï¸  Warning: Could not store API Gateway URL (continuing anyway)"
          fi
          
          # Store S3 bucket name
          S3_BUCKET=$(terraform -chdir=infra output -raw s3_bucket_name)
          if aws ssm put-parameter --name "/project3/s3-bucket" --value "$S3_BUCKET" --type "String" --overwrite; then
            echo "âœ… Stored S3 Bucket: $S3_BUCKET"
          else
            echo "âš ï¸  Warning: Could not store S3 bucket name (continuing anyway)"
          fi
          
          # Store CloudFront distribution ID
          CLOUDFRONT_ID=$(terraform -chdir=infra output -raw cloudfront_distribution_id)
          if aws ssm put-parameter --name "/project3/cloudfront-distribution-id" --value "$CLOUDFRONT_ID" --type "String" --overwrite; then
            echo "âœ… Stored CloudFront Distribution ID: $CLOUDFRONT_ID"
          else
            echo "âš ï¸  Warning: Could not store CloudFront distribution ID (continuing anyway)"
          fi
          
          # Store Lambda function name
          LAMBDA_NAME=$(terraform -chdir=infra output -raw lambda_function_name)
          if aws ssm put-parameter --name "/project3/lambda-function-name" --value "$LAMBDA_NAME" --type "String" --overwrite; then
            echo "âœ… Stored Lambda Function Name: $LAMBDA_NAME"
          else
            echo "âš ï¸  Warning: Could not store Lambda function name (continuing anyway)"
          fi
          
          echo "âœ… Infrastructure deployment and SSM parameter storage completed!"
          
          # Update web pipeline configuration with actual GitHub token
          echo "ğŸ”§ Updating web pipeline configuration..."
          GITHUB_TOKEN=$(aws ssm get-parameter --name "/project3/github/token" --with-decryption --region eu-north-1 --query 'Parameter.Value' --output text)
          
          # Create temporary pipeline file with token replaced
          sed "s/{{GITHUB_TOKEN}}/$GITHUB_TOKEN/g" web-pipeline.json > web-pipeline-updated.json
          
          # Update the web pipeline with the new configuration
          if aws codepipeline update-pipeline --cli-input-json file://web-pipeline-updated.json --region eu-north-1; then
            echo "âœ… Updated web pipeline with GitHub token"
          else
            echo "âš ï¸  Warning: Could not update web pipeline"
          fi
          
          # Start the web pipeline (CodePipeline, not CodeBuild)
          echo "ğŸš€ Starting web pipeline..."
          if aws codepipeline start-pipeline-execution --name project3-web-pipeline --region eu-north-1; then
            echo "âœ… Started web pipeline execution"
          else
            echo "âš ï¸  Warning: Could not start web pipeline (check if it exists)"
          fi
          
          echo "ğŸ‰ Infrastructure deployment completed!"
          echo "ğŸ“ SSM parameters stored for web pipeline consumption"
          echo "ğŸ”„ Web pipeline execution initiated"
        fi

artifacts:
  files:
    - 'infra/tfplan'
    - 'infra/coverage.out'
    - 'infra/terraform.tfstate'
    - 'web-pipeline.json'
  name: infra-artifacts

cache:
  paths:
    - 'infra/.terraform/**/*'
