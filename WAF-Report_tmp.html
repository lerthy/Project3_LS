<!DOCTYPE html>
<html>

<head>
    <title>WAF-Report.md</title>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    
<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

html,footer,header{
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Custom MD PDF CSS
 */
html,footer,header{
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";

 }
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>
<link rel="stylesheet" href="file:///Users/lerdisalihi/Downloads/Project3_LS-develop%205/R%3A%5C2.Travail%5C1.Enseignement%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css"><link rel="stylesheet" href="file:///Users/lerdisalihi/Downloads/Project3_LS-develop%205/D%3A%5Crdaros%5CCours%5C_1.Outils%5C2.Developpement%5C1.SCSS%5Cmain.css" type="text/css">
</head>

<body>
    <h1 id="well-architected-framework-waf-review-%E2%80%93-devops-cicd-project">Well-Architected Framework (WAF) Review â€“ DevOps CI/CD Project</h1>
<h2 id="instructions">Instructions</h2>
<ol>
<li>Baseline: Briefly describe your existing setup (tools, repos, target environment, runtime). 15 sentences max.</li>
<li>Per pillar: Fill the sections below:
<ul>
<li>Current state</li>
<li>Gaps</li>
<li>TF improvements</li>
<li>Evidence</li>
</ul>
</li>
<li>Terraform: Implement or reference TF changes that realize improvements.</li>
<li>Validation: Link evidence (TF code lines, logs, screenshots) where possible.</li>
</ol>
<hr>
<h2 id="baseline">Baseline</h2>
<ul>
<li>Tools: AWS (S3, CloudFront, API Gateway, Lambda, RDS, CloudWatch), CodePipeline, CodeBuild, SSM Parameter Store, Terraform, Go (tests), Node.js 18 (web, lambda), ESLint, Stylelint, Vitest.</li>
<li>Repositories/Monorepo: Single repo with <code>infra/</code> (Terraform), <code>cicd/</code> (pipelines), and <code>web/</code> (static site + lambda).</li>
<li>Environments (dev/stage/prod): Single &quot;development&quot; environment tags; pipelines branch-driven (<code>develop</code>).</li>
<li>Cloud provider/region(s): AWS <code>us-east-1</code> (set in buildspecs and Terraform backend).</li>
<li>Runtimes (frontend/backend/lambdas/DB): Static web (HTML/CSS/JS), Node.js Lambda for contact form, PostgreSQL RDS, API Gateway REST API.</li>
<li>CI/CD (build, test, deploy): Two CodePipelines (infra &amp; web) with CodeBuild steps; linting and tests in <code>buildspec-*.yml</code>; S3 deploy, Lambda update, CloudFront invalidation.</li>
<li>IaC (Terraform versions/modules): Terraform &gt;=1.3 (backend S3/DynamoDB); modules for <code>s3</code>, <code>cloudfront</code>, <code>rds</code>, <code>lambda</code>, <code>api-gateway</code>, <code>iam</code>, <code>monitoring</code>, and <code>cicd</code>.</li>
<li>Observability (logs/metrics/tracing): CloudWatch logs for Lambda via <code>AWSLambdaBasicExecutionRole</code>; CloudWatch billing alarm; CodeBuild/CodePipeline logs.</li>
<li>Networking (VPCs/subnets): Uses default VPC only for RDS security group; Lambda not in VPC; API Gateway public; CloudFront over S3 OAI.</li>
<li>Security (IAM/KMS/secrets mgmt): IAM roles for CodeBuild/CodePipeline/Lambda; SSM parameters for DB creds; S3 public access blocked; CloudFront OAI for S3.</li>
<li>Data stores (RDS/S3/others): RDS Postgres instance; S3 website and artifacts buckets; SSM Parameter Store for config.</li>
<li>Edge/CDN: CloudFront distribution with HTTPS redirect; OAI restricting S3.</li>
<li>Key SLIs/SLOs: Not explicitly defined in repo.</li>
</ul>
<hr>
<h2 id="1-operational-excellence">1) Operational Excellence</h2>
<h3 id="current-state">Current state</h3>
<ul>
<li>CI/CD via two CodePipelines with CodeBuild projects; infra pipeline runs fmt/validate/plan/apply; web pipeline runs lint/tests and deploys static site + Lambda + CF invalidation.</li>
<li>Common tagging in Terraform locals; basic Go test scaffold present for infra.</li>
</ul>
<h3 id="gaps">Gaps</h3>
<ul>
<li>No alarms/notifications on pipeline or build failures; no manual approval gates.</li>
<li>Limited automated tests (Terratest skipped); no runbooks.</li>
</ul>
<h3 id="tf-improvements">TF improvements</h3>
<ul>
<li>Add CloudWatch alarms + SNS topics for CodeBuild/CodePipeline failures; add manual approval stage in pipelines.</li>
<li>Add Terratest stage and enforce on PRs; expand tagging (owner, cost-center, service, environment).</li>
</ul>
<h3 id="evidence">Evidence</h3>
<ul>
<li><code>cicd/main.tf</code> (CodePipeline, CodeBuild stages)</li>
<li><code>buildspec-infra.yml</code>, <code>buildspec-web.yml</code> (lint/test/plan/apply/deploy)</li>
<li><code>infra/main.tf</code> locals <code>common_tags</code></li>
<li><code>infra/tests/infra_integration_test.go</code></li>
</ul>
<hr>
<h2 id="2-security">2) Security</h2>
<h3 id="current-state">Current state</h3>
<ul>
<li>S3 website bucket blocks public access; CloudFront OAI policy restricts reads.</li>
<li>API Gateway POST/OPTIONS without auth; RDS SG allows 0.0.0.0/0 to 5432 (demo).</li>
<li>Terraform remote state in S3 with DynamoDB lock and encryption.</li>
<li>DB credentials stored in SSM Parameter Store (<code>/rds/db_username</code>, <code>/rds/db_password</code> SecureString, <code>/rds/db_name</code>, <code>/rds/rds_address</code>) and read by Lambda at runtime.</li>
<li>There are no Network ACLs (NACLs) configured for your VPC subnets. All subnet-level traffic filtering is handled by default AWS settings and security groups.</li>
</ul>
<h3 id="gaps">Gaps</h3>
<ul>
<li>RDS publicly accessible SG; Lambda not in VPC; no KMS CMKs for S3/RDS.</li>
<li>API lacks authentication/authorization and WAF; CodeBuild IAM policies broad with wildcards.</li>
<li>No secret rotation; SSM path not scoped to environment.</li>
<li>Missing stateless, subnet-level traffic filtering</li>
<li>No defense-in-depth at the subnet layer</li>
<li>Cannot explicitly deny unwanted IPs or ports at the subnet level</li>
</ul>
<h3 id="tf-improvements">TF improvements</h3>
<ul>
<li>Place RDS in private subnets and restrict SG to Lambda/VPC CIDR; attach KMS CMK to RDS and S3.</li>
<li>Put Lambda in VPC with least-priv SG; add Secrets Manager for credentials with rotation; scope SSM paths by env.</li>
<li>Add API auth (API key/JWT/Cognito) and AWS WAF ACL; tighten IAM to least privilege.</li>
<li>Define a NACL resource in Terraform</li>
</ul>
<h3 id="evidence">Evidence</h3>
<ul>
<li><code>infra/modules/s3/main.tf</code> (public access block, OAI policy)</li>
<li><code>infra/modules/cloudfront/main.tf</code> (HTTPS redirect, OAI)</li>
<li><code>infra/modules/lambda/main.tf</code> (IAM role, SSM policy)</li>
<li><code>infra/modules/api-gateway/main.tf</code> (no auth)</li>
<li><code>infra/modules/rds/main.tf</code> (public SG 0.0.0.0/0)</li>
<li><code>infra/backend.tf</code> (S3 backend with DynamoDB lock)</li>
</ul>
<h3 id="improvements-made-code-refs">Improvements made (code refs)</h3>
<p>S3 website bucket versioning: <code>infra/modules/s3/main.tf</code> lines 9-15</p>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_versioning&quot; &quot;website_versioning&quot; {
  bucket = aws_s3_bucket.website.id
  versioning_configuration {
    status = &quot;Enabled&quot;
  }
}
</div></code></pre>
<p>S3 website bucket encryption: <code>infra/modules/s3/main.tf</code> lines 17-26</p>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;website_encryption&quot; {
  bucket = aws_s3_bucket.website.id
  rule { apply_server_side_encryption_by_default { sse_algorithm = &quot;AES256&quot; } }
}
</div></code></pre>
<p>S3 artifacts versioning: <code>infra/modules/s3/main.tf</code> lines 79-84</p>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_versioning&quot; &quot;codepipeline_artifacts_versioning&quot; {
  bucket = aws_s3_bucket.codepipeline_artifacts.id
  versioning_configuration {
    status = &quot;Enabled&quot;
  }
}
</div></code></pre>
<p>S3 artifacts encryption: <code>infra/modules/s3/main.tf</code> lines 86-95</p>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_server_side_encryption_configuration&quot; &quot;codepipeline_artifacts_encryption&quot; {
  bucket = aws_s3_bucket.codepipeline_artifacts.id

  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm = &quot;AES256&quot;
    }
  }
}
</div></code></pre>
<p>CloudFront security headers policy: <code>infra/modules/cloudfront/main.tf</code> lines 20-37</p>
<pre class="hljs"><code><div>default_cache_behavior {
  allowed_methods  = [&quot;GET&quot;, &quot;HEAD&quot;]
  cached_methods   = [&quot;GET&quot;, &quot;HEAD&quot;]
  target_origin_id = &quot;s3-origin&quot;

  forwarded_values {
    query_string = false
    cookies {
      forward = &quot;none&quot;
    }
  }

  viewer_protocol_policy     = &quot;redirect-to-https&quot;
  min_ttl                    = 0
  default_ttl                = 3600
  max_ttl                    = 86400
  response_headers_policy_id = &quot;60669652-455b-4ae9-85a4-c4c02393f86c&quot; # AWSManagedSecurityHeadersPolicy
}
</div></code></pre>
<p>CloudFront minimum TLS version: <code>infra/modules/cloudfront/main.tf</code> lines 45-48</p>
<pre class="hljs"><code><div>viewer_certificate {
  cloudfront_default_certificate = true
  minimum_protocol_version       = &quot;TLSv1.2_2021&quot;
}
</div></code></pre>
<p>API Gateway access logs: <code>infra/modules/api-gateway/main.tf</code> lines 101-123</p>
<pre class="hljs"><code><div>resource &quot;aws_api_gateway_stage&quot; &quot;contact_stage&quot; {
  deployment_id = aws_api_gateway_deployment.contact_deployment.id
  rest_api_id   = aws_api_gateway_rest_api.contact_api.id
  stage_name    = var.stage_name

  access_log_settings {
    destination_arn = aws_cloudwatch_log_group.api_gw_logs.arn
    format = jsonencode({
      requestId               = &quot;$context.requestId&quot;,
      ip                      = &quot;$context.identity.sourceIp&quot;,
      caller                  = &quot;$context.identity.caller&quot;,
      user                    = &quot;$context.identity.user&quot;,
      requestTime             = &quot;$context.requestTime&quot;,
      httpMethod              = &quot;$context.httpMethod&quot;,
      resourcePath            = &quot;$context.resourcePath&quot;,
      status                  = &quot;$context.status&quot;,
      protocol                = &quot;$context.protocol&quot;,
      responseLength          = &quot;$context.responseLength&quot;,
      integrationStatus       = &quot;$context.integration.status&quot;,
      integrationError        = &quot;$context.integrationErrorMessage&quot;
    })
  }
}
</div></code></pre>
<p>API Gateway log group and method throttling: <code>infra/modules/api-gateway/main.tf</code> lines 125-145</p>
<pre class="hljs"><code><div>resource &quot;aws_cloudwatch_log_group&quot; &quot;api_gw_logs&quot; {
  name              = &quot;/apigw/${aws_api_gateway_rest_api.contact_api.id}/${var.stage_name}&quot;
  retention_in_days = 14
  tags              = var.tags
}

resource &quot;aws_api_gateway_method_settings&quot; &quot;all&quot; {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  stage_name  = aws_api_gateway_stage.contact_stage.stage_name
  method_path = &quot;*/*&quot;

  settings {
    metrics_enabled        = true
    logging_level          = &quot;INFO&quot;
    data_trace_enabled     = true
    throttling_burst_limit = 5
    throttling_rate_limit  = 10
  }
}
</div></code></pre>
<p>WAFv2 WebACL and association: <code>infra/modules/api-gateway/main.tf</code> lines 147-181</p>
<pre class="hljs"><code><div>resource &quot;aws_wafv2_web_acl&quot; &quot;apigw_acl&quot; {
  name        = &quot;apigw-basic-acl&quot;
  description = &quot;Basic protections for API Gateway&quot;
  scope       = &quot;REGIONAL&quot;
  default_action {
    allow {}
  }
  rule {
    name     = &quot;AWS-AWSManagedRulesCommonRuleSet&quot;
    priority = 1
    statement {
      managed_rule_group_statement {
        name        = &quot;AWSManagedRulesCommonRuleSet&quot;
        vendor_name = &quot;AWS&quot;
      }
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = &quot;AWSManagedRulesCommonRuleSet&quot;
      sampled_requests_enabled   = true
    }
  }
  visibility_config {
    cloudwatch_metrics_enabled = true
    metric_name                = &quot;apigw-acl&quot;
    sampled_requests_enabled   = true
  }
  tags = var.tags
}

resource &quot;aws_wafv2_web_acl_association&quot; &quot;apigw_acl_assoc&quot; {
  resource_arn = aws_api_gateway_stage.contact_stage.arn
  web_acl_arn  = aws_wafv2_web_acl.apigw_acl.arn
}
</div></code></pre>
<p>Lambda VPC access policy: <code>infra/modules/lambda/main.tf</code> lines 21-25</p>
<pre class="hljs"><code><div>resource &quot;aws_iam_role_policy_attachment&quot; &quot;lambda_vpc_access&quot; {
  role       = aws_iam_role.lambda_exec.name
  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&quot;
}
</div></code></pre>
<p>Lambda security group: <code>infra/modules/lambda/main.tf</code> lines 39-52</p>
<pre class="hljs"><code><div>resource &quot;aws_security_group&quot; &quot;lambda_sg&quot; {
  name_prefix = &quot;lambda-sg-&quot;
  description = &quot;Security group for Lambda to access RDS&quot;
  vpc_id      = data.aws_vpc.default.id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = &quot;-1&quot;
    cidr_blocks = [&quot;0.0.0.0/0&quot;]
  }

  tags = merge(var.tags, { Name = &quot;lambda-sg&quot; })
}
</div></code></pre>
<p>Lambda VPC config on function: <code>infra/modules/lambda/main.tf</code> lines 89-92</p>
<pre class="hljs"><code><div>vpc_config {
  subnet_ids         = data.aws_subnets.default_vpc_subnets.ids
  security_group_ids = [aws_security_group.lambda_sg.id]
}
</div></code></pre>
<p>RDS SG ingress from Lambda SG: <code>infra/modules/rds/main.tf</code> lines 6-17</p>
<pre class="hljs"><code><div>resource &quot;aws_security_group&quot; &quot;rds_ingress&quot; {
  name_prefix = &quot;rds-ingress-5432-&quot;
  description = &quot;Allow inbound to Postgres from Lambda SG&quot;
  vpc_id      = data.aws_vpc.default.id

  ingress {
    from_port                = 5432
    to_port                  = 5432
    protocol                 = &quot;tcp&quot;
    security_groups          = [var.allowed_sg_id]
    description              = &quot;Allow Postgres from Lambda security group&quot;
  }
}
</div></code></pre>
<p>RDS private/encrypted + SG attach: <code>infra/modules/rds/main.tf</code> lines 48-58</p>
<pre class="hljs"><code><div>resource &quot;aws_db_instance&quot; &quot;contact_db&quot; {
  storage_encrypted   = var.storage_encrypted
  publicly_accessible = var.publicly_accessible
  vpc_security_group_ids = [aws_security_group.rds_ingress.id]
}
</div></code></pre>
<p>IAM narrowed S3 bucket resources: <code>infra/modules/iam/main.tf</code> lines 276-279</p>
<pre class="hljs"><code><div>        Resource = [
          var.artifacts_bucket_arn,
          var.website_bucket_arn
        ]
</div></code></pre>
<p>Secrets Manager secret and version: <code>infra/main.tf</code> lines 58-75</p>
<pre class="hljs"><code><div>resource &quot;aws_secretsmanager_secret&quot; &quot;db_credentials&quot; {
  name        = &quot;project3/db-credentials&quot;
  description = &quot;Database credentials for contact form&quot;
  tags        = local.common_tags
}

resource &quot;aws_secretsmanager_secret_version&quot; &quot;db_credentials_version&quot; {
  secret_id     = aws_secretsmanager_secret.db_credentials.id
  secret_string = jsonencode({
    username = coalesce(var.db_username, data.aws_ssm_parameter.db_username.value)
    password = coalesce(var.db_password, data.aws_ssm_parameter.db_password.value)
    host     = module.rds.rds_address
    database = coalesce(var.db_name, data.aws_ssm_parameter.db_name.value)
    port     = module.rds.rds_port
  })
  depends_on = [module.rds]
}
</div></code></pre>
<ul>
<li>Rotation function and rotation rule: <code>infra/main.tf</code> lines 76-103</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_serverlessapplicationrepository_cloudformation_stack&quot; &quot;rds_rotation&quot; {
  name           = &quot;project3-rds-rotation&quot;
  application_id = &quot;arn:aws:serverlessrepo:us-east-1:297356227824:applications/SecretsManagerRDSPostgreSQLRotationSingleUser&quot;
  capabilities   = [&quot;CAPABILITY_NAMED_IAM&quot;]
  parameters = {
    functionName        = &quot;project3-rds-rotation&quot;
    vpcSubnetIds        = join(&quot;,&quot;, data.aws_subnets.default_vpc_subnets.ids)
    vpcSecurityGroupIds = module.lambda.lambda_security_group_id
  }
  semantic_version = &quot;1.1.188&quot;
  tags             = local.common_tags
}

resource &quot;aws_secretsmanager_secret_rotation&quot; &quot;db_rotation&quot; {
  secret_id           = aws_secretsmanager_secret.db_credentials.id
  rotation_lambda_arn = aws_serverlessapplicationrepository_cloudformation_stack.rds_rotation.outputs[&quot;RotationLambdaARN&quot;]
  rotation_rules { automatically_after_days = 30 }
  depends_on = [aws_secretsmanager_secret_version.db_credentials_version]
}
</div></code></pre>
<ul>
<li>Lambda environment + IAM for secret read: <code>infra/modules/lambda/main.tf</code> lines 56-66, 70-90</li>
</ul>
<pre class="hljs"><code><div>environment {
  variables = {
    ENVIRONMENT  = &quot;development&quot;
    DB_SECRET_ARN = var.db_secret_arn
  }
}
</div></code></pre>
<pre class="hljs"><code><div>resource &quot;aws_iam_role_policy&quot; &quot;lambda_secrets_policy&quot; {
  name = &quot;lambda-secrets-access&quot;
  role = aws_iam_role.lambda_exec.id
  policy = jsonencode({
    Version = &quot;2012-10-17&quot;,
    Statement = [{
      Effect = &quot;Allow&quot;,
      Action = [&quot;secretsmanager:GetSecretValue&quot;,&quot;secretsmanager:DescribeSecret&quot;],
      Resource = var.db_secret_arn
    }]
  })
}
</div></code></pre>
<ul>
<li>Lambda code reads from Secrets Manager with SSM fallback: <code>web/lambda/index.js</code> lines 1-18, 21-40, 44-74</li>
</ul>
<pre class="hljs"><code><div>// Security note: Database credentials are retrieved from AWS SSM Parameter Store, not environment variables.
import { Client } from &quot;pg&quot;;
import { SSMClient, GetParameterCommand } from &quot;@aws-sdk/client-ssm&quot;;
import { SecretsManagerClient, GetSecretValueCommand } from &quot;@aws-sdk/client-secrets-manager&quot;;

// Initialize AWS clients
const region = process.env.AWS_REGION || 'us-east-1';
const ssmClient = new SSMClient({ region });
const secretsClient = new SecretsManagerClient({ region });
</div></code></pre>
<pre class="hljs"><code><div>// Cache for database credentials to avoid repeated SSM calls
let dbCredentials = null;

// Function to get database credentials (Secrets Manager preferred, fallback to SSM)
async function getDbCredentials() {
  if (dbCredentials) {
    return dbCredentials;
  }

  try {
    const secretArn = process.env.DB_SECRET_ARN;
    if (secretArn) {
      const secretData = await secretsClient.send(new GetSecretValueCommand({ SecretId: secretArn }));
      const secret = JSON.parse(secretData.SecretString || '{}');
      dbCredentials = { host: secret.host, user: secret.username, password: secret.password, database: secret.database };
    } else {
      // Fallback to SSM parameters
</div></code></pre>
<pre class="hljs"><code><div>      const [dbHost, dbUser, dbPass, dbName] = await Promise.all([
        ssmClient.send(new GetParameterCommand({ Name: &quot;/rds/rds_address&quot; })),
        ssmClient.send(new GetParameterCommand({ Name: &quot;/rds/db_username&quot; })),
        ssmClient.send(new GetParameterCommand({ Name: &quot;/rds/db_password&quot;, WithDecryption: true })),
        ssmClient.send(new GetParameterCommand({ Name: &quot;/rds/db_name&quot; }))
      ]);
      dbCredentials = { host: dbHost.Parameter.Value, user: dbUser.Parameter.Value, password: dbPass.Parameter.Value, database: dbName.Parameter.Value };
    }
    return dbCredentials;
  } catch (error) {
    console.error(&quot;Failed to retrieve database credentials:&quot;, error);
    throw new Error(&quot;Database configuration error&quot;);
  }
}
</div></code></pre>
<p>-Network ACLs (NACLs) have been implemented in your Terraform VPC module.<code>infra/vpc/main.tf</code> line 124-194</p>
<pre class="hljs"><code><div># Network ACLs for Public Subnets
resource &quot;aws_network_acl&quot; &quot;public&quot; {
  vpc_id = aws_vpc.main.id
  tags = merge(var.tags, { Name = &quot;${var.environment}-public-nacl&quot; })
}

# Allow HTTPS inbound, deny all else (example)
resource &quot;aws_network_acl_rule&quot; &quot;public_https_inbound&quot; {
  network_acl_id = aws_network_acl.public.id
  rule_number    = 100
  egress         = false
  protocol       = &quot;tcp&quot;
  rule_action    = &quot;allow&quot;
  cidr_block     = &quot;0.0.0.0/0&quot;
  from_port      = 443
  to_port        = 443
}

resource &quot;aws_network_acl_rule&quot; &quot;public_deny_all_inbound&quot; {
  network_acl_id = aws_network_acl.public.id
  rule_number    = 200
  egress         = false
  protocol       = &quot;-1&quot;
  rule_action    = &quot;deny&quot;
  cidr_block     = &quot;0.0.0.0/0&quot;
  from_port      = 0
  to_port        = 0
}

# Associate Public NACL with Public Subnets
resource &quot;aws_network_acl_association&quot; &quot;public&quot; {
  count          = length(var.public_subnet_cidrs)
  subnet_id      = aws_subnet.public[count.index].id
  network_acl_id = aws_network_acl.public.id
}

# Network ACLs for Private Subnets
resource &quot;aws_network_acl&quot; &quot;private&quot; {
  vpc_id = aws_vpc.main.id
  tags = merge(var.tags, { Name = &quot;${var.environment}-private-nacl&quot; })
}

# Allow DB traffic from Lambda SG CIDR (example: adjust as needed)
resource &quot;aws_network_acl_rule&quot; &quot;private_db_inbound&quot; {
  network_acl_id = aws_network_acl.private.id
  rule_number    = 100
  egress         = false
  protocol       = &quot;tcp&quot;
  rule_action    = &quot;allow&quot;
  cidr_block     = &quot;10.0.0.0/8&quot; # Example CIDR, adjust to Lambda SG subnet
  from_port      = 5432
  to_port        = 5432
}

resource &quot;aws_network_acl_rule&quot; &quot;private_deny_all_inbound&quot; {
  network_acl_id = aws_network_acl.private.id
  rule_number    = 200
  egress         = false
  protocol       = &quot;-1&quot;
  rule_action    = &quot;deny&quot;
  cidr_block     = &quot;0.0.0.0/0&quot;
  from_port      = 0
  to_port        = 0
}

# Associate Private NACL with Private Subnets
resource &quot;aws_network_acl_association&quot; &quot;private&quot; {
  count          = length(var.private_subnet_cidrs)
  subnet_id      = aws_subnet.private[count.index].id
  network_acl_id = aws_network_acl.private.id
}
</div></code></pre>
<hr>
<h2 id="3-reliability">3) Reliability</h2>
<h3 id="current-state">Current state</h3>
<ul>
<li>Single RDS instance in primary region without Multi-AZ</li>
<li>Basic RDS backups and maintenance windows configured</li>
<li>No cross-region disaster recovery setup</li>
<li>No automated failover mechanism</li>
<li>RPO/RTO requirements not met (e-commerce needs: RPO 1h, RTO 4h)</li>
</ul>
<h3 id="gaps">Gaps</h3>
<ul>
<li>Single point of failure with non-Multi-AZ RDS</li>
<li>No cross-region redundancy for disaster recovery</li>
<li>Missing health checks and automated failover</li>
<li>No warm standby setup to meet RTO requirement</li>
<li>Backup strategy insufficient for RPO requirement</li>
<li>No DLQ or retries on Lambda functions</li>
<li>Missing monitoring and alerting system</li>
</ul>
<h3 id="tf-improvements">TF improvements</h3>
<ol>
<li>
<p>Implement Warm Standby Architecture:</p>
<ul>
<li>Deploy standby RDS in us-west-2</li>
<li>Configure cross-region replication</li>
<li>Set up Route53 health checks and failover routing</li>
<li>Enable Multi-AZ for primary RDS</li>
</ul>
</li>
<li>
<p>Enhance Monitoring and Recovery:</p>
<ul>
<li>Add CloudWatch alarms for API errors (4XX/5XX)</li>
<li>Monitor Lambda performance and failures</li>
<li>Create operational dashboards</li>
<li>Implement automated failover testing</li>
</ul>
</li>
<li>
<p>Improve Data Protection:</p>
<ul>
<li>Configure RDS automated backups every 15 minutes</li>
<li>Enable point-in-time recovery</li>
<li>Implement cross-region S3 replication</li>
<li>Set up proper backup retention policies</li>
</ul>
</li>
</ol>
<h3 id="evidence">Evidence</h3>
<ul>
<li><code>infra/modules/monitoring/main.tf</code> (only billing alarm)</li>
<li><code>infra/modules/api-gateway/main.tf</code> (stage definition)</li>
<li><code>infra/modules/lambda/main.tf</code> (no DLQ)</li>
<li><code>infra/modules/rds/main.tf</code> (backup/deletion flags)</li>
</ul>
<h3 id="reliability-improvements-code-refs">Reliability improvements (code refs)</h3>
<h4 id="warm-standby-architecture-decision">Warm Standby Architecture Decision</h4>
<p>The decision to implement a warm standby architecture was based on the following requirements and considerations:</p>
<ol>
<li>
<p><strong>Recovery Time Objective (RTO)</strong>:</p>
<ul>
<li>Requirement: 4 hours maximum downtime allowed</li>
<li>Warm standby provides faster recovery compared to cold standby or backup/restore</li>
<li>Pre-provisioned infrastructure reduces deployment time during failover</li>
</ul>
</li>
<li>
<p><strong>Recovery Point Objective (RPO)</strong>:</p>
<ul>
<li>Requirement: Maximum 1 hour of data loss acceptable</li>
<li>Continuous replication of data to standby region meets this requirement</li>
<li>S3 cross-region replication for static content</li>
<li>Database replication for dynamic data</li>
</ul>
</li>
<li>
<p><strong>Traffic Pattern Analysis</strong>:</p>
<ul>
<li>Steady, predictable traffic pattern</li>
<li>Non-spiky workload suits warm standby's cost-effectiveness</li>
<li>Lower cost compared to active-active while meeting RPO/RTO</li>
</ul>
</li>
<li>
<p><strong>Cost-Benefit Analysis</strong>:</p>
<ul>
<li>Warm standby provides optimal balance between recovery speed and cost</li>
<li>Standby resources can run on smaller instances to reduce costs</li>
<li>No need for complex active-active synchronization</li>
</ul>
</li>
<li>
<p><strong>Operational Complexity</strong>:</p>
<ul>
<li>Simpler than active-active architecture</li>
<li>Automated failover through Route53 health checks</li>
<li>Clear, well-defined failover process</li>
<li>Easier to test and maintain</li>
</ul>
</li>
</ol>
<h4 id="summary-of-reliability-improvements">Summary of Reliability Improvements</h4>
<p>We implemented a warm standby architecture and enhanced reliability with the following changes:</p>
<ul>
<li>
<p><strong>Created standby RDS module in a different region:</strong></p>
<ul>
<li>Folder: <code>infra/modules/rds-standby/</code></li>
<li>Files: <code>main.tf</code>, <code>variables.tf</code>, <code>outputs.tf</code></li>
<li>Purpose: Deploys a scaled-down standby PostgreSQL RDS instance in <code>us-west-2</code>.</li>
</ul>
</li>
<li>
<p><strong>Enabled S3 cross-region replication for static assets:</strong></p>
<ul>
<li>File: <code>infra/modules/s3/replication.tf</code></li>
<li>Purpose: Replicates website bucket to standby region for DR.</li>
</ul>
</li>
<li>
<p><strong>Configured Route53 DNS failover for APIs:</strong></p>
<ul>
<li>File: <code>infra/modules/route53/failover.tf</code></li>
<li>Supporting files: <code>variables.tf</code>, <code>outputs.tf</code></li>
<li>Purpose: Automated DNS failover between primary and standby API endpoints.</li>
</ul>
</li>
<li>
<p><strong>Documented the warm standby setup and failover process:</strong></p>
<ul>
<li>File: <code>WARM-STANDBY-README.md</code> (project root)</li>
<li>Purpose: Instructions and validation steps for disaster recovery.</li>
</ul>
</li>
</ul>
<p>All new modules follow Terraform best practices with variables, outputs, and clear separation of primary/standby resources.</p>
<p>Key code implementations:</p>
<ol>
<li>RDS Standby Configuration:</li>
</ol>
<pre class="hljs"><code><div># infra/modules/rds-standby/main.tf
resource &quot;aws_db_instance&quot; &quot;contact_db_standby&quot; {
  identifier           = &quot;contact-db-standby&quot;
  engine              = &quot;postgres&quot;
  instance_class      = &quot;db.t3.micro&quot;  # Scaled down for cost in standby
  allocated_storage   = 20
  storage_encrypted   = true
  
  backup_retention_period = 7
  backup_window          = &quot;03:00-04:00&quot;
  maintenance_window     = &quot;Mon:04:00-Mon:05:00&quot;
  
  multi_az            = false  # Single AZ for standby to reduce costs
  publicly_accessible = false
  
  vpc_security_group_ids = [aws_security_group.rds_standby_sg.id]
  db_subnet_group_name   = aws_db_subnet_group.standby_subnet_group.name
  
  tags = merge(var.tags, {
    Name = &quot;contact-db-standby&quot;
    Role = &quot;warm-standby&quot;
  })
}
</div></code></pre>
<ol start="2">
<li>S3 Cross-Region Replication:</li>
</ol>
<pre class="hljs"><code><div># infra/modules/s3/replication.tf
resource &quot;aws_s3_bucket_replication_configuration&quot; &quot;website_replication&quot; {
  role   = aws_iam_role.replication_role.arn
  bucket = aws_s3_bucket.website.id

  rule {
    id     = &quot;website-standby-replication&quot;
    status = &quot;Enabled&quot;

    destination {
      bucket        = aws_s3_bucket.website_standby.arn
      storage_class = &quot;STANDARD&quot;
    }
  }
}
</div></code></pre>
<ol start="3">
<li>Route53 DNS Failover:</li>
</ol>
<pre class="hljs"><code><div># infra/modules/route53/failover.tf
resource &quot;aws_route53_health_check&quot; &quot;primary_api&quot; {
  fqdn              = var.primary_api_domain
  port              = 443
  type              = &quot;HTTPS&quot;
  resource_path     = &quot;/health&quot;
  failure_threshold = &quot;3&quot;
  request_interval  = &quot;30&quot;
  
  tags = merge(var.tags, {
    Name = &quot;primary-api-health-check&quot;
  })
}

resource &quot;aws_route53_record&quot; &quot;api_primary&quot; {
  zone_id = var.hosted_zone_id
  name    = var.api_domain
  type    = &quot;A&quot;
  
  failover_routing_policy {
    type = &quot;PRIMARY&quot;
  }
  
  alias {
    name                   = var.primary_api_domain
    zone_id               = var.primary_api_zone_id
    evaluate_target_health = true
  }
  
  health_check_id = aws_route53_health_check.primary_api.id
  set_identifier  = &quot;primary&quot;
}

resource &quot;aws_route53_record&quot; &quot;api_secondary&quot; {
  zone_id = var.hosted_zone_id
  name    = var.api_domain
  type    = &quot;A&quot;
  
  failover_routing_policy {
    type = &quot;SECONDARY&quot;
  }
  
  alias {
    name                   = var.standby_api_domain
    zone_id               = var.standby_api_zone_id
    evaluate_target_health = true
  }
  
  set_identifier = &quot;secondary&quot;
}

---

- Lambda reserved concurrency: `infra/modules/lambda/main.tf` lines 109-111
```109:111:infra/modules/lambda/main.tf
# Reserve concurrency to prevent thundering herds and protect DB
reserved_concurrent_executions = 5
</div></code></pre>
<ul>
<li>Lambda DLQ and invoke config: <code>infra/modules/lambda/main.tf</code> lines 130-145</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_sqs_queue&quot; &quot;lambda_dlq&quot; {
  name = &quot;contact-form-dlq&quot;
  tags = var.tags
}

resource &quot;aws_lambda_event_invoke_config&quot; &quot;contact_eic&quot; {
  function_name = aws_lambda_function.contact.function_name
  destination_config { on_failure { destination = aws_sqs_queue.lambda_dlq.arn } }
  maximum_retry_attempts       = 2
  maximum_event_age_in_seconds = 3600
}
</div></code></pre>
<ul>
<li>Lambda errors alarm: <code>infra/modules/monitoring/main.tf</code> lines 25-42</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;lambda_errors&quot; {
  alarm_name          = &quot;lambda-contact-errors&quot;
  comparison_operator = &quot;GreaterThanThreshold&quot;
  evaluation_periods  = 1
  metric_name         = &quot;Errors&quot;
  namespace           = &quot;AWS/Lambda&quot;
  period              = 60
  statistic           = &quot;Sum&quot;
  threshold           = 1
  alarm_actions       = var.alarm_actions
  dimensions = { FunctionName = var.lambda_function_name }
}
</div></code></pre>
<ul>
<li>Lambda p95 duration alarm: <code>infra/modules/monitoring/main.tf</code> lines 44-60</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;lambda_duration&quot; {
  alarm_name          = &quot;lambda-contact-duration-p95&quot;
  comparison_operator = &quot;GreaterThanThreshold&quot;
  evaluation_periods  = 1
  metric_name         = &quot;Duration&quot;
  namespace           = &quot;AWS/Lambda&quot;
  period              = 60
  statistic           = &quot;p95&quot;
  threshold           = 3000
  alarm_actions       = var.alarm_actions
  dimensions = { FunctionName = var.lambda_function_name }
}
</div></code></pre>
<ul>
<li>API Gateway 5XX alarm: <code>infra/modules/monitoring/main.tf</code> lines 62-79</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;apigw_5xx&quot; {
  alarm_name          = &quot;apigw-5xx-errors&quot;
  comparison_operator = &quot;GreaterThanThreshold&quot;
  evaluation_periods  = 1
  metric_name         = &quot;5XXError&quot;
  namespace           = &quot;AWS/ApiGateway&quot;
  period              = 60
  statistic           = &quot;Sum&quot;
  threshold           = 1
  alarm_actions       = var.alarm_actions
  dimensions = { ApiId = var.api_gateway_id, Stage = var.api_gateway_stage, Resource = &quot;/contact&quot;, Method = &quot;POST&quot; }
}
</div></code></pre>
<ul>
<li>Multi-AZ for primary RDS and DMS cross-region replication:</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_db_instance&quot; &quot;contact_db&quot; {
  # ...existing config...
  multi_az = true
  # Cross-region replication with AWS DMS
  # See DMS resources below
}
</div></code></pre>
<ul>
<li>DMS replication resources:</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_dms_replication_instance&quot; &quot;rds_replication&quot; { ... }
resource &quot;aws_dms_endpoint&quot; &quot;source&quot; { ... }
resource &quot;aws_dms_endpoint&quot; &quot;target&quot; { ... }
resource &quot;aws_dms_replication_task&quot; &quot;rds_to_standby&quot; { ... }
resource &quot;aws_dms_replication_subnet_group&quot; &quot;dms_subnet_group&quot; { ... }
</div></code></pre>
<ul>
<li>DMS table mappings and task settings:</li>
</ul>
<pre class="hljs"><code><div>{
  &quot;rules&quot;: [
    {
      &quot;rule-type&quot;: &quot;selection&quot;,
      &quot;rule-id&quot;: &quot;1&quot;,
      &quot;rule-name&quot;: &quot;1&quot;,
      &quot;object-locator&quot;: {
        &quot;schema-name&quot;: &quot;%&quot;,
        &quot;table-name&quot;: &quot;%&quot;
      },
      &quot;rule-action&quot;: &quot;include&quot;
    }
  ]
}
</div></code></pre>
<pre class="hljs"><code><div>{
  &quot;TargetMetadata&quot;: { ... },
  &quot;FullLoadSettings&quot;: { ... },
  &quot;Logging&quot;: { ... },
  &quot;ControlTablesSettings&quot;: { ... },
  &quot;StreamBufferSettings&quot;: { ... },
  &quot;ChangeProcessingDdlHandlingPolicy&quot;: { ... },
  &quot;ErrorBehavior&quot;: { ... },
  &quot;ChangeProcessingPolicy&quot;: { ... }
}
</div></code></pre>
<ul>
<li>S3 lifecycle for backup retention:</li>
</ul>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;website_lifecycle&quot; {
  bucket = aws_s3_bucket.website.id
  rule {
    id     = &quot;cleanup_old_versions&quot;
    status = &quot;Enabled&quot;
    filter {
      prefix = &quot;&quot;
    }
    noncurrent_version_expiration {
      noncurrent_days = 30
    }
  }
}
</div></code></pre>
<hr>
<h2 id="4-performance-efficiency">4) Performance Efficiency</h2>
<h3 id="current-state">Current state</h3>
<p>Initial performance analysis revealed several areas needing optimization:</p>
<ol>
<li>
<p>Content Delivery Network (CDN):</p>
<ul>
<li>S3 + CloudFront distribution with basic 24-hour TTL</li>
<li>No compression enabled for static assets</li>
<li>Missing Cache-Control headers for browser caching</li>
<li>Default CloudFront settings without optimization</li>
</ul>
</li>
<li>
<p>API Gateway and Lambda:</p>
<ul>
<li>Default Lambda configuration (128MB memory, 3s timeout)</li>
<li>No API Gateway caching implemented</li>
<li>Missing throttling and concurrency controls</li>
<li>Basic database connection handling</li>
</ul>
</li>
<li>
<p>Database Layer:</p>
<ul>
<li>RDS PostgreSQL on db.t3.micro (baseline tier)</li>
<li>Default parameter group without tuning</li>
<li>No Performance Insights monitoring</li>
<li>Basic connection management</li>
</ul>
</li>
<li>
<p>Performance Monitoring:</p>
<ul>
<li>Limited visibility into system performance</li>
<li>No comprehensive monitoring dashboard</li>
<li>Missing performance metrics collection</li>
<li>No automated performance alerting</li>
</ul>
</li>
</ol>
<h3 id="improvements-made">Improvements Made</h3>
<ol>
<li>
<p>Content Delivery Network Optimization:</p>
<ul>
<li>Enabled CloudFront compression with Brotli support</li>
<li>Implemented tiered TTL strategy:
<ul>
<li>Static assets: 1-year cache (31536000s)</li>
<li>Dynamic content: 24-hour cache (86400s)</li>
<li>API responses: 5-minute cache (300s)</li>
</ul>
</li>
<li>Added Cache-Control headers via CloudFront policies</li>
<li>Configured optimal compression settings for asset types</li>
</ul>
</li>
<li>
<p>API and Lambda Performance Enhancements:</p>
<ul>
<li>Increased Lambda memory to 256MB for better performance</li>
<li>Extended timeout to 10s for reliable operation</li>
<li>Added API Gateway caching (0.5GB cache size)</li>
<li>Implemented database connection pooling</li>
<li>Set up provisioned concurrency (2 instances)</li>
</ul>
</li>
<li>
<p>Database Optimizations:</p>
<ul>
<li>Upgraded to db.t3.small for improved performance</li>
<li>Enabled Performance Insights (7-day retention)</li>
<li>Optimized database parameters:
<ul>
<li>Shared buffers: 20% of instance memory</li>
<li>Work memory: 8MB per connection</li>
<li>Max connections: 100</li>
</ul>
</li>
<li>Implemented enhanced monitoring (60s intervals)</li>
</ul>
</li>
<li>
<p>Performance Monitoring Framework:</p>
<ul>
<li>Created comprehensive CloudWatch dashboard</li>
<li>Set up performance metric alarms</li>
<li>Added API Gateway metrics tracking</li>
<li>Implemented Lambda performance monitoring</li>
</ul>
</li>
</ol>
<h3 id="evidence">Evidence</h3>
<ul>
<li>
<p>CloudFront basic config: <code>infra/modules/cloudfront/main.tf</code> lines 15-25:</p>
<pre class="hljs"><code><div>default_cache_behavior {
  min_ttl = 0
  default_ttl = 86400  # 24 hours default
  max_ttl = 31536000   # 1 year max
}
</div></code></pre>
</li>
<li>
<p>Lambda basic settings: <code>infra/modules/lambda/main.tf</code> lines 45-48:</p>
<pre class="hljs"><code><div>resource &quot;aws_lambda_function&quot; &quot;contact_form&quot; {
  memory_size = 128  # Default memory
  timeout     = 3    # Default timeout
}
</div></code></pre>
</li>
<li>
<p>API Gateway without caching: <code>infra/modules/api-gateway/main.tf</code> lines 89-95:</p>
<pre class="hljs"><code><div>resource &quot;aws_api_gateway_stage&quot; &quot;api&quot; {
  # No cache_cluster_enabled setting
  # No method_settings for caching
}
</div></code></pre>
</li>
<li>
<p>RDS base configuration: <code>infra/modules/rds/main.tf</code> lines 25-30:</p>
<pre class="hljs"><code><div>resource &quot;aws_db_instance&quot; &quot;contact_db&quot; {
  instance_class = &quot;db.t3.micro&quot;
  # No performance_insights_enabled
  # Default parameter group
}
</div></code></pre>
</li>
</ul>
<h3 id="performance-improvements-code-refs">Performance improvements (code refs)</h3>
<h4 id="1-cloudfront-optimizations">1. CloudFront Optimizations</h4>
<p>CloudFront compression and caching: <code>infra/modules/cloudfront/main.tf</code> lines 30-52</p>
<pre class="hljs"><code><div>resource &quot;aws_cloudfront_distribution&quot; &quot;website&quot; {
  # ... existing configuration ...

  default_cache_behavior {
    compress               = true
    viewer_protocol_policy = &quot;redirect-to-https&quot;
    
    min_ttl               = 0
    default_ttl           = 86400    # 24 hours
    max_ttl               = 31536000 # 1 year
    
    cached_methods        = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;]
    allowed_methods       = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;]

    forwarded_values {
      query_string = false
      cookies { forward = &quot;none&quot; }
      headers      = [&quot;Origin&quot;, &quot;Access-Control-Request-Method&quot;, &quot;Access-Control-Request-Headers&quot;]
    }
  }

  ordered_cache_behavior {
    path_pattern     = &quot;/assets/*&quot;
    allowed_methods  = [&quot;GET&quot;, &quot;HEAD&quot;]
    cached_methods   = [&quot;GET&quot;, &quot;HEAD&quot;]
    target_origin_id = aws_s3_bucket.website.id

    compress               = true
    viewer_protocol_policy = &quot;redirect-to-https&quot;
    
    min_ttl               = 86400    # 1 day
    default_ttl           = 604800   # 1 week
    max_ttl               = 31536000 # 1 year
  }
}
</div></code></pre>
<p>CloudFront response headers policy: <code>infra/modules/cloudfront/main.tf</code> lines 54-75</p>
<pre class="hljs"><code><div>resource &quot;aws_cloudfront_response_headers_policy&quot; &quot;security_headers&quot; {
  name = &quot;performance-security-headers&quot;

  custom_headers_config {
    items {
      header   = &quot;Cache-Control&quot;
      value    = &quot;public, max-age=31536000&quot;
      override = true
    }
    items {
      header   = &quot;Accept-Encoding&quot;
      value    = &quot;gzip, deflate, br&quot;
      override = true
    }
  }

  security_headers_config {
    content_type_options {
      override = true
    }
    frame_options {
      frame_option = &quot;DENY&quot;
      override = true
    }
    strict_transport_security {
      access_control_max_age_sec = 31536000
      include_subdomains = true
      override = true
    }
  }
}
</div></code></pre>
<h4 id="2-api-gateway-caching">2. API Gateway Caching</h4>
<p>API Gateway cache settings: <code>infra/modules/api-gateway/main.tf</code> lines 150-180</p>
<pre class="hljs"><code><div>resource &quot;aws_api_gateway_stage&quot; &quot;contact_stage&quot; {
  # ... existing configuration ...

  cache_cluster_enabled = true
  cache_cluster_size   = &quot;0.5&quot;  # 0.5GB cache

  variables = {
    &quot;cacheEnabled&quot; = &quot;true&quot;
  }
}

resource &quot;aws_api_gateway_method_settings&quot; &quot;contact_cache&quot; {
  rest_api_id = aws_api_gateway_rest_api.contact_api.id
  stage_name  = aws_api_gateway_stage.contact_stage.stage_name
  method_path = &quot;*/*&quot;

  settings {
    metrics_enabled        = true
    logging_level         = &quot;INFO&quot;
    caching_enabled      = true
    cache_ttl_in_seconds = 300  # 5 minutes cache
    
    throttling_burst_limit = 100
    throttling_rate_limit  = 50
  }
}
</div></code></pre>
<h4 id="3-lambda-optimization">3. Lambda Optimization</h4>
<p>Lambda performance configuration: <code>infra/modules/lambda/main.tf</code> lines 80-110</p>
<pre class="hljs"><code><div>resource &quot;aws_lambda_function&quot; &quot;contact_form&quot; {
  # ... existing configuration ...

  memory_size = 256
  timeout     = 10

  environment {
    variables = {
      NODE_OPTIONS = &quot;--enable-source-maps&quot;
      POSTGRES_MAX_CONNECTIONS = &quot;10&quot;
    }
  }

  provisioned_concurrent_executions = 2

  vpc_config {
    subnet_ids         = data.aws_subnets.default_vpc_subnets.ids
    security_group_ids = [aws_security_group.lambda_sg.id]
  }
}

# Add connection pooling utility
resource &quot;aws_lambda_layer_version&quot; &quot;pg_pool&quot; {
  layer_name          = &quot;pg-pool-layer&quot;
  description         = &quot;PostgreSQL connection pooling layer&quot;
  filename            = &quot;layers/pg-pool.zip&quot;
  compatible_runtimes = [&quot;nodejs18.x&quot;]
}
</div></code></pre>
<h4 id="4-rds-performance">4. RDS Performance</h4>
<p>RDS performance configuration: <code>infra/modules/rds/main.tf</code> lines 85-120</p>
<pre class="hljs"><code><div>resource &quot;aws_db_parameter_group&quot; &quot;contact_db_params&quot; {
  name   = &quot;contact-db-params&quot;
  family = &quot;postgres14&quot;

  parameter {
    name  = &quot;shared_buffers&quot;
    value = &quot;{DBInstanceClassMemory*20/100}&quot;  # 20% of instance memory
  }

  parameter {
    name  = &quot;max_connections&quot;
    value = &quot;100&quot;
  }

  parameter {
    name  = &quot;work_mem&quot;
    value = &quot;8388608&quot;  # 8MB
  }
}

resource &quot;aws_db_instance&quot; &quot;contact_db&quot; {
  # ... existing configuration ...

  instance_class = &quot;db.t3.small&quot;
  
  # Enable performance insights
  performance_insights_enabled             = true
  performance_insights_retention_period    = 7
  performance_insights_kms_key_id         = aws_kms_key.pi_key.arn

  # Use optimized parameters
  parameter_group_name = aws_db_parameter_group.contact_db_params.name

  # Enable enhanced monitoring
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring.arn
}
</div></code></pre>
<h4 id="5-performance-monitoring">5. Performance Monitoring</h4>
<p>CloudWatch dashboard: <code>infra/modules/monitoring/main.tf</code> lines 130-180</p>
<pre class="hljs"><code><div>resource &quot;aws_cloudwatch_dashboard&quot; &quot;performance&quot; {
  dashboard_name = &quot;performance-metrics&quot;

  dashboard_body = jsonencode({
    widgets = [
      {
        type   = &quot;metric&quot;
        width  = 12
        height = 6
        properties = {
          metrics = [
            [&quot;AWS/ApiGateway&quot;, &quot;Latency&quot;, &quot;ApiName&quot;, aws_api_gateway_rest_api.contact_api.name],
            [&quot;AWS/ApiGateway&quot;, &quot;CacheHitCount&quot;, &quot;ApiName&quot;, aws_api_gateway_rest_api.contact_api.name],
            [&quot;AWS/ApiGateway&quot;, &quot;CacheMissCount&quot;, &quot;ApiName&quot;, aws_api_gateway_rest_api.contact_api.name]
          ]
          period = 300
          stat   = &quot;Average&quot;
          region = data.aws_region.current.name
          title  = &quot;API Gateway Performance&quot;
        }
      },
      {
        type   = &quot;metric&quot;
        width  = 12
        height = 6
        properties = {
          metrics = [
            [&quot;AWS/Lambda&quot;, &quot;Duration&quot;, &quot;FunctionName&quot;, aws_lambda_function.contact_form.name],
            [&quot;AWS/Lambda&quot;, &quot;ConcurrentExecutions&quot;, &quot;FunctionName&quot;, aws_lambda_function.contact_form.name],
            [&quot;AWS/Lambda&quot;, &quot;ProvisionedConcurrencySpillover&quot;, &quot;FunctionName&quot;, aws_lambda_function.contact_form.name]
          ]
          period = 300
          stat   = &quot;Average&quot;
          region = data.aws_region.current.name
          title  = &quot;Lambda Performance&quot;
        }
      }
    ]
  })
}
</div></code></pre>
<hr>
<h2 id="5-cost-optimization">5) Cost Optimization</h2>
<h3 id="current-state">Current state</h3>
<ul>
<li>CloudWatch billing alarm configured; artifacts bucket versioning enabled.</li>
<li>RDS configured for free-tier friendly options; final snapshot skipped to reduce cost.</li>
</ul>
<h3 id="gaps">Gaps</h3>
<ul>
<li>S3 lifecycle rules for website/artifacts removed/commented; no asset TTL strategy.</li>
<li>Always-on RDS; no CloudFront log analysis for cost vs value.</li>
</ul>
<h3 id="tf-improvements">TF improvements</h3>
<ul>
<li>Re-enable S3 lifecycle for noncurrent versions and multipart cleanup; set appropriate Cache-Control for static assets.</li>
<li>Add cost-focused dashboards/alarms (S3 bytes, Lambda duration, API Gateway costs); right-size resources regularly.</li>
<li>Consider Aurora Serverless v2 if persistence needs grow with variable load.</li>
</ul>
<h3 id="evidence">Evidence</h3>
<ul>
<li><code>infra/modules/monitoring/main.tf</code> (billing alarm)</li>
<li><code>infra/modules/s3/main.tf</code> (artifacts versioning; lifecycle commented out)</li>
<li><code>infra/modules/rds/main.tf</code> (free-tier settings)</li>
</ul>
<hr>
<h2 id="6-sustainability">6) Sustainability</h2>
<h3 id="current-state">Current state</h3>
<ul>
<li>Static hosting with CDN and serverless compute reduces idle waste; web images include WebP formats.</li>
<li>Use S3 Intelligent-Tiering for storage to optimize energy and cost based on access patterns.</li>
<li>Enable S3 lifecycle rules for all buckets to automatically delete old versions and unused objects.</li>
<li>Monitor and report carbon footprint using AWS CloudWatch and third-party tools (e.g., AWS Customer Carbon Footprint Tool).</li>
</ul>
<h3 id="gaps">Gaps</h3>
<ul>
<li>RDS instance is always-on; caching/TTLs not optimized; no autoscaling or scheduled scale-down.</li>
<li>Higher energy consumption and carbon footprint due to always-on resources and inefficient scaling.</li>
<li>Missed opportunities for cost savings with S3 storage and lifecycle management.</li>
</ul>
<h3 id="tf-improvements">TF improvements</h3>
<ul>
<li>Optimize CloudFront and S3 caching policies (set appropriate Cache-Control headers, enable Brotli/gzip compression).</li>
<li>Add Terraform resources for monitoring and reporting carbon footprint (e.g., CloudWatch dashboards, custom metrics).</li>
<li>Tag all resources with sustainability-related metadata (e.g., â€œenvironmentâ€, â€œpurposeâ€, â€œownerâ€) for tracking and reporting.</li>
<li>Audit and optimize static assets (images, JS, CSS) during CI/CD; automate with Terraform and build steps.</li>
</ul>
<h3 id="evidence">Evidence</h3>
<ul>
<li><code>web/static/images/*.webp</code> (optimized images)</li>
<li><code>infra/modules/cloudfront/main.tf</code> (caching)</li>
</ul>
<h3 id="sustainability-improvements-code-refs">Sustainability improvements (code refs)</h3>
<h4 id="1-cloudfront-compression--caching">1. CloudFront Compression &amp; Caching</h4>
<p>-Enabled Brotli/gzip compression and tiered TTLs for static assets.</p>
<pre class="hljs"><code><div>default_cache_behavior {
    allowed_methods  = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;]
    cached_methods   = [&quot;GET&quot;, &quot;HEAD&quot;, &quot;OPTIONS&quot;]
    target_origin_id = &quot;s3-origin&quot;
    compress        = true

    forwarded_values {
      query_string = false
      cookies {
        forward = &quot;none&quot;
      }
      headers = [&quot;Origin&quot;, &quot;Access-Control-Request-Method&quot;, &quot;Access-Control-Request-Headers&quot;]
    }

    viewer_protocol_policy     = &quot;redirect-to-https&quot;
    min_ttl                    = 0
    default_ttl                = 86400    # 24 hours
    max_ttl                    = 31536000 # 1 year
    response_headers_policy_id = aws_cloudfront_response_headers_policy.optimized.id
  }
</div></code></pre>
<h4 id="2-s3-lifecycle-rules">2. S3 Lifecycle Rules</h4>
<p>-Automatic cleanup of old versions and incomplete multipart uploads.</p>
<pre class="hljs"><code><div>resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;website_lifecycle&quot; {
  bucket = aws_s3_bucket.website.id
  rule {
    id     = &quot;cleanup_old_versions&quot;
    status = &quot;Enabled&quot;
    filter {
      prefix = &quot;&quot;
    }
    noncurrent_version_expiration {
      noncurrent_days = 30
    }
    abort_incomplete_multipart_upload {
      days_after_initiation = 7
    }
  }
}
</div></code></pre>
<h3 id="3-carbon-footprint-monitoring">3. Carbon Footprint Monitoring</h3>
<p>-CloudWatch dashboard and custom metrics for sustainability reporting.</p>
<pre class="hljs"><code><div> properties = {
          metrics = [
            [&quot;AWS/Usage&quot;, &quot;CarbonFootprint&quot;, &quot;Service&quot;, &quot;EC2&quot;, { stat = &quot;Sum&quot; }],
            [&quot;AWS/Usage&quot;, &quot;CarbonFootprint&quot;, &quot;Service&quot;, &quot;S3&quot;, { stat = &quot;Sum&quot; }],
            [&quot;AWS/Usage&quot;, &quot;CarbonFootprint&quot;, &quot;Service&quot;, &quot;Lambda&quot;, { stat = &quot;Sum&quot; }]
          ]
          period = 86400
          region = data.aws_region.current.name
          title  = &quot;AWS Carbon Footprint (Daily)&quot;
        }
</div></code></pre>
<h3 id="4-resource-tagging">4. Resource Tagging</h3>
<p>-Sustainability-related metadata tags (environment, purpose, owner) on all resources.</p>
<pre class="hljs"><code><div># Common tags
locals {
  common_tags = {
    Environment   = &quot;development&quot;
    Project       = &quot;assignment&quot;
    ManagedBy     = &quot;terraform&quot;
    Purpose       = &quot;sustainability&quot;
    Owner         = &quot;DevOpsTeam&quot;
    Sustainability = &quot;true&quot;
  }
}

</div></code></pre>
<h3 id="5-cicd-asset-optimization">5. CI/CD Asset Optimization</h3>
<p>-Automated image, JS, and CSS optimization in build pipeline.<br>
-buildspec-web.yml</p>
<pre class="hljs"><code><div># Optimize static assets (images, JS, CSS)
  - echo &quot;Optimizing static assets...&quot;
  - npm --prefix web run optimize:assets || echo &quot;Asset optimization skipped (no script)&quot;
  - echo &quot;Building static site...&quot;
</div></code></pre>
<p>-package.json</p>
<pre class="hljs"><code><div>  &quot;optimize:assets&quot;: &quot;npx imagemin static/images/* --out-dir=static/images &amp;&amp; npx terser static/js/*.js -o static/js/ --compress --mangle &amp;&amp; npx postcss static/css/*.css -o static/css/&quot;

</div></code></pre>
<hr>
<h2 id="action-items-optional">Action Items (Optional)</h2>
<ul>
<li>Priority P0:
<ul>
<li>Remove RDS public ingress and move DB to private subnets with strict SGs.</li>
<li>Add API authentication (e.g., Cognito/JWT) and attach AWS WAF to API.</li>
<li>Add CloudWatch alarms + SNS for CodeBuild/CodePipeline failures and Lambda errors.</li>
</ul>
</li>
<li>Priority P1:
<ul>
<li>Place Lambda in VPC and restrict egress; add DLQ and reserved concurrency.</li>
<li>Re-enable S3 lifecycle for website/artifacts; set Cache-Control headers via deploy step.</li>
<li>Tighten IAM policies for CodeBuild/CodePipeline to least privilege.</li>
</ul>
</li>
<li>Priority P2:
<ul>
<li>Enable API Gateway access logs/caching; add dashboards for API and Lambda.</li>
<li>Evaluate Multi-AZ for RDS and Performance Insights; consider Aurora Serverless v2.</li>
<li>Add Terratest-based infra tests in CI and manual approval gates for prod.</li>
</ul>
</li>
</ul>
<h2 id="notes-optional">Notes (Optional)</h2>
<ul>
<li></li>
</ul>

</body>

</html>